<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Strav Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-800 overflow-x-hidden">

    <!-- Auth Section -->
    <div id="auth-container" class="max-w-md mx-auto min-h-screen flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full border border-blue-50 text-center">
            <h1 class="text-5xl font-black text-blue-600 mb-2 italic tracking-tighter">STRAV</h1>
            <p class="text-gray-400 font-bold text-[10px] uppercase mb-10 tracking-widest">Premium Tournament</p>
            <div class="space-y-4">
                <input id="email" type="email" placeholder="Email Address" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-400">
                <input id="password" type="password" placeholder="Password" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="handleAuth()" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl shadow-lg shadow-blue-200">LOGIN</button>
                <button onclick="toggleAuth()" class="text-xs font-bold text-blue-500 mt-4 uppercase">New User? Register</button>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen pb-24 hidden relative bg-gray-50">
        <header class="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-50 border-b">
            <h1 class="font-black text-2xl text-blue-600 italic tracking-tighter">STRAV</h1>
            <div class="flex items-center gap-3">
                <button onclick="shareApp()" class="w-9 h-9 flex items-center justify-center text-gray-400 bg-gray-100 rounded-full shadow-inner"><i class="fas fa-share-alt"></i></button>
                <div onclick="navigate('wallet')" class="bg-blue-50 px-4 py-1.5 rounded-full border border-blue-100 font-black text-blue-700 text-sm cursor-pointer shadow-sm">
                    ₹<span id="user-balance">0</span>
                </div>
            </div>
        </header>

        <main id="main-content" class="p-4 space-y-4"></main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around p-4 shadow-2xl z-50 rounded-t-[2.5rem]">
            <button onclick="navigate('home')" id="nav-home" class="nav-btn text-blue-600 flex flex-col items-center"><i class="fas fa-gamepad text-xl"></i><span class="text-[9px] font-black mt-1 uppercase">Matches</span></button>
            <button onclick="navigate('mycontests')" id="nav-my" class="nav-btn text-gray-400 flex flex-col items-center"><i class="fas fa-trophy text-xl"></i><span class="text-[9px] font-black mt-1 uppercase">Joined</span></button>
            <button onclick="navigate('wallet')" id="nav-wallet" class="nav-btn text-gray-400 flex flex-col items-center"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] font-black mt-1 uppercase">Wallet</span></button>
            <button onclick="navigate('profile')" id="nav-profile" class="nav-btn text-gray-400 flex flex-col items-center"><i class="fas fa-headset text-xl"></i><span class="text-[9px] font-black mt-1 uppercase">Support</span></button>
        </nav>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmFnbCqdXp4FbKtlMa9a1TjZTIUlzB6uE",
            authDomain: "strav-tournament-app.firebaseapp.com",
            databaseURL: "https://strav-tournament-app-default-rtdb.firebaseio.com",
            projectId: "strav-tournament-app",
            storageBucket: "strav-tournament-app.firebasestorage.app",
            messagingSenderId: "873709853744",
            appId: "1:873709853744:web:0d03269c05d480747e61f5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let isLogin = true;
        let currentPage = 'home';
        let clickCount = 0;

        // --- ANDROID BACK BUTTON TRAP ---
        // Isse user back dabayega toh app close nahi hoga
        function initBackControl() {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                if (currentPage !== 'home') {
                    navigate('home');
                    window.history.pushState(null, null, window.location.href);
                } else {
                    window.history.pushState(null, null, window.location.href);
                    alert("Click Profile > Sign Out to exit.");
                }
            };
        }
        initBackControl();

        // --- HIGH EARNING AD LOGIC (Pop-under) ---
        function triggerHighEarningAd() {
            clickCount++;
            // Har 4 clicks par ek baar Pop-under script load hoga
            // Isse earning bhi maintain rahegi aur user ko space bhi milega
            if (clickCount % 4 === 0) {
                const adScript = document.createElement('script');
                adScript.src = "https://pl28731178.effectivegatecpm.com/64/6f/11/646f11b8e09d654e15dab856d3770e4c.js";
                document.body.appendChild(adScript);
                console.log("Pop-under Triggered for Revenue");
            }
        }

        // Click listener for all actions
        document.addEventListener('click', () => {
            if (!document.getElementById('auth-container').classList.contains('hidden')) return;
            triggerHighEarningAd();
        });

        function toggleAuth() { isLogin = !isLogin; }
        
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Fill details!");
            try {
                if(isLogin) await auth.signInWithEmailAndPassword(email, pass);
                else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ email, balance: 0 });
                }
            } catch(e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                db.ref('users/' + user.uid).on('value', s => { if(s.val()) document.getElementById('user-balance').innerText = s.val().balance || 0; });
                navigate('home');
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        function navigate(page) {
            currentPage = page;
            const main = document.getElementById('main-content');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-blue-600', 'text-gray-400'));
            const activeId = { 'home': 'nav-home', 'mycontests': 'nav-my', 'wallet': 'nav-wallet', 'profile': 'nav-profile' };
            document.getElementById(activeId[page]).classList.replace('text-gray-400', 'text-blue-600');

            if(page === 'home') renderHome();
            else if(page === 'mycontests') renderMyContests();
            else if(page === 'wallet') renderWallet();
            else if(page === 'profile') renderProfile();
        }

        function renderHome() {
            const main = document.getElementById('main-content');
            main.innerHTML = `<h2 class="font-black text-xl mb-4 text-gray-700 italic">Live Tournaments</h2><div id="t-list" class="space-y-4"></div>`;
            db.ref('tournaments').on('value', snap => {
                let html = '';
                snap.forEach(t => {
                    const v = t.val();
                    if(v.status === 'open') {
                        html += `<div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100">
                            <div class="flex justify-between items-start">
                                <div><span class="text-[9px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase tracking-widest">${v.game}</span><h3 class="font-black text-lg mt-1">${v.title}</h3></div>
                                <div class="text-right text-blue-600 font-black text-xl">₹${v.fee}</div>
                            </div>
                            <button onclick="joinMatch('${t.key}', ${v.fee})" class="w-full mt-4 py-3.5 bg-blue-600 text-white font-black rounded-2xl shadow-lg">JOIN NOW</button>
                        </div>`;
                    }
                });
                document.getElementById('t-list').innerHTML = html || 'No Matches Available';
            });
        }

        async function joinMatch(tid, fee) {
            const userSnap = await db.ref('users/' + auth.currentUser.uid).get();
            const bal = userSnap.val().balance || 0;
            if(bal < fee) return alert("Paisa kam hai! Wallet recharge karein.");
            if(confirm("Join Match?")) {
                await db.ref('users/' + auth.currentUser.uid).update({ balance: bal - fee });
                const tSnap = await db.ref('tournaments/' + tid).get();
                await db.ref('tournaments/' + tid).update({ joinedCount: (tSnap.val().joinedCount || 0) + 1 });
                await db.ref(`tournaments/${tid}/players/${auth.currentUser.uid}`).set({ email: auth.currentUser.email });
                alert("Match Joined!");
                navigate('mycontests');
            }
        }

        function renderMyContests() {
            const main = document.getElementById('main-content');
            main.innerHTML = `<h2 class="font-black text-xl mb-4">My Contests</h2><div id="my-list" class="space-y-4"></div>`;
            db.ref('tournaments').on('value', snap => {
                let html = '';
                snap.forEach(t => {
                    const v = t.val();
                    if(v.players && v.players[auth.currentUser.uid]) {
                        html += `<div class="bg-white p-5 rounded-3xl border-l-[10px] border-blue-600 shadow-sm">
                            <h3 class="font-black text-lg">${v.title}</h3>
                            <p class="text-xs font-bold mt-2 text-gray-500">Room ID: ${v.roomID || 'TBA'} | Pass: ${v.roomPass || 'TBA'}</p>
                        </div>`;
                    }
                });
                document.getElementById('my-list').innerHTML = html || 'No joined matches.';
            });
        }

        function renderWallet() {
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div class="bg-gradient-to-br from-blue-600 to-blue-400 p-8 rounded-[2.5rem] text-white text-center shadow-xl">
                    <p class="text-xs uppercase opacity-70 mb-2 font-bold tracking-widest">Balance</p>
                    <h2 class="text-5xl font-black italic tracking-tighter">₹${document.getElementById('user-balance').innerText}</h2>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button onclick="addCash()" class="bg-white p-5 rounded-3xl border font-black text-xs text-green-500 shadow-sm active:scale-95 transition-all">ADD CASH</button>
                    <button onclick="withdraw()" class="bg-white p-5 rounded-3xl border font-black text-xs text-red-500 shadow-sm active:scale-95 transition-all">WITHDRAW</button>
                </div>
            `;
        }

        async function addCash() {
            const amt = prompt("Amount ₹:");
            const ref = prompt("Transaction ID (Ref):");
            if(amt && ref) {
                await db.ref('transactions').push({ uid: auth.currentUser.uid, email: auth.currentUser.email, amount: parseInt(amt), method: ref, type: 'add', status: 'pending', timestamp: Date.now() });
                alert("Deposit Request Sent!");
            }
        }

        async function withdraw() {
            const amt = prompt("Amount ₹:");
            const upi = prompt("UPI ID:");
            if(amt && upi) {
                await db.ref('transactions').push({ uid: auth.currentUser.uid, email: auth.currentUser.email, amount: parseInt(amt), method: upi, type: 'withdraw', status: 'pending', timestamp: Date.now() });
                alert("Withdraw Request Sent!");
            }
        }

        function renderProfile() {
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="bg-white p-8 rounded-[2.5rem] shadow-sm border text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center text-blue-600 text-3xl font-black border-4 border-white shadow-md">${auth.currentUser.email[0].toUpperCase()}</div>
                <h2 class="font-black text-lg text-gray-800">${auth.currentUser.email}</h2>
                <div class="mt-8 space-y-4">
                    <a href="https://t.me/strav_support" class="block p-4 bg-gray-50 rounded-2xl border font-black text-xs text-[#0088cc] shadow-sm">TELEGRAM SUPPORT</a>
                    <button onclick="shareApp()" class="w-full p-4 bg-orange-50 rounded-2xl border font-black text-xs text-orange-600 shadow-sm">SHARE APP</button>
                    <button onclick="auth.signOut()" class="w-full text-red-500 font-black text-xs pt-4 italic">Sign Out</button>
                </div>
            </div>`;
        }

        function shareApp() {
            const text = "Play Strav Tournament & Win Cash! Download: " + window.location.href;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
    </script>
</body>
</html>
    
